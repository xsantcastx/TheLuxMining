<div class="gallery-uploader">
  <!-- Existing Images -->
  @if (existingMedia.length > 0) {
    <div class="mb-6">
      <h4 class="text-sm font-semibold text-gray-700 mb-3">Existing Gallery Images ({{ existingMedia.length }})</h4>
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        @for (media of existingMedia; track media.id) {
          <div class="relative group rounded-lg overflow-hidden border-2 border-gray-200 bg-white">
            <img 
              [src]="media.url" 
              [alt]="media.altText || media.filename"
              class="w-full h-40 object-cover"
            />
            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 transition-all">
              <button
                type="button"
                (click)="removeExistingMedia(media.id!)"
                class="absolute top-2 right-2 p-2 bg-red-600 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-700"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
            <div class="p-2">
              <p class="text-xs text-gray-600 truncate">{{ media.filename }}</p>
              <p class="text-xs text-gray-500">{{ media.width }}x{{ media.height }}px</p>
              <div class="flex flex-wrap gap-1 mt-1">
                @for (tag of media.tags; track tag) {
                  <span class="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded">{{ tag }}</span>
                }
              </div>
            </div>
          </div>
        }
      </div>
    </div>
  }

  <!-- Drop Zone -->
  <div
    class="border-2 border-dashed rounded-xl p-8 text-center transition-colors"
    [class.border-blue-500]="isDragging"
    [class.bg-blue-50]="isDragging"
    [class.border-gray-300]="!isDragging"
    [class.bg-gray-50]="!isDragging"
    (dragover)="onDragOver($event)"
    (dragleave)="onDragLeave($event)"
    (drop)="onDrop($event)"
  >
    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
      <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <div class="mt-4">
      <label for="gallery-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500">
        <span>Upload gallery images</span>
        <input
          id="gallery-upload"
          type="file"
          multiple
          accept="image/jpeg,image/jpg,image/png,image/webp"
          (change)="onFileSelected($event)"
          class="sr-only"
        />
      </label>
      <p class="text-sm text-gray-500 mt-1">or drag and drop</p>
    </div>
    <p class="text-xs text-gray-500 mt-2">
      PNG, JPG, WEBP up to 10MB. Minimum {{ minWidth }}x{{ minHeight }}px
    </p>
  </div>

  <!-- Error Message -->
  @if (errorMessage) {
    <div class="mt-4 p-4 bg-red-50 border border-red-200 rounded-xl">
      <p class="text-sm text-red-700">{{ errorMessage }}</p>
    </div>
  }

  <!-- Image Previews -->
  @if (previews.length > 0) {
    <div class="mt-6">
      <div class="flex items-center justify-between mb-3">
        <h4 class="text-sm font-semibold text-gray-700">
          New Images ({{ uploadedCount }}/{{ previews.length }})
        </h4>
        @if (hasUnsavedImages) {
          <button
            type="button"
            (click)="uploadAll()"
            [disabled]="isUploading"
            class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            @if (isUploading) {
              <span>Uploading...</span>
            } @else {
              <span>Upload All ({{ unsavedCount }})</span>
            }
          </button>
        }
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        @for (preview of previews; track $index; let i = $index) {
          <div class="border-2 rounded-xl overflow-hidden bg-white" [class.border-green-500]="preview.mediaId" [class.border-gray-200]="!preview.mediaId">
            <div class="flex">
              <!-- Image Preview -->
              <div class="w-32 h-32 flex-shrink-0 bg-gray-100">
                <img 
                  [src]="preview.preview" 
                  [alt]="preview.file.name"
                  class="w-full h-full object-cover"
                />
              </div>

              <!-- Info & Tags -->
              <div class="flex-1 p-3">
                <div class="flex items-start justify-between mb-2">
                  <div class="flex-1 min-w-0 mr-2">
                    <p class="text-sm font-medium text-gray-900 truncate">{{ preview.file.name }}</p>
                    @if (preview.dimensions) {
                      <p class="text-xs text-gray-500">{{ preview.dimensions.width }}x{{ preview.dimensions.height }}px</p>
                    }
                    <p class="text-xs text-gray-500">{{ (preview.file.size / 1024 / 1024).toFixed(2) }}MB</p>
                  </div>
                  <button
                    type="button"
                    (click)="removePreview(i)"
                    [disabled]="preview.uploading"
                    class="p-1 text-gray-400 hover:text-red-600 disabled:opacity-50"
                  >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                  </button>
                </div>

                <!-- Tags -->
                <div class="space-y-1">
                  <p class="text-xs font-medium text-gray-700">Tags:</p>
                  <div class="flex flex-wrap gap-1">
                    @for (tag of availableTags; track tag) {
                      <button
                        type="button"
                        (click)="toggleTag(preview, tag)"
                        [disabled]="preview.uploading"
                        class="px-2 py-1 text-xs rounded transition-colors disabled:opacity-50"
                        [class.bg-blue-600]="isTagSelected(preview, tag)"
                        [class.text-white]="isTagSelected(preview, tag)"
                        [class.bg-gray-200]="!isTagSelected(preview, tag)"
                        [class.text-gray-700]="!isTagSelected(preview, tag)"
                        [class.hover:bg-blue-500]="isTagSelected(preview, tag)"
                        [class.hover:bg-gray-300]="!isTagSelected(preview, tag)"
                      >
                        {{ tag }}
                      </button>
                    }
                  </div>
                </div>

                <!-- Upload Progress -->
                @if (preview.uploading) {
                  <div class="mt-2">
                    <div class="w-full bg-gray-200 rounded-full h-2">
                      <div 
                        class="bg-blue-600 h-2 rounded-full transition-all duration-300"
                        [style.width.%]="preview.uploadProgress"
                      ></div>
                    </div>
                    <p class="text-xs text-gray-600 mt-1">{{ preview.uploadProgress }}%</p>
                  </div>
                }

                <!-- Upload Status -->
                @if (preview.mediaId) {
                  <div class="mt-2 flex items-center text-green-600">
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    <span class="text-xs font-medium">Uploaded</span>
                  </div>
                }

                <!-- Error -->
                @if (preview.error) {
                  <p class="mt-2 text-xs text-red-600">{{ preview.error }}</p>
                }
              </div>
            </div>
          </div>
        }
      </div>
    </div>
  }

  <!-- Summary -->
  @if (totalImages > 0) {
    <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
      <p class="text-sm text-blue-800">
        <span class="font-semibold">Total gallery images:</span> {{ totalImages }}
        ({{ existingMedia.length }} existing + {{ previews.length }} new)
      </p>
    </div>
  }
</div>
